import tkinter as tk
from tkinter import filedialog, messagebox
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import pandas as pd

class FTIRPlotter:
    def __init__(self, root):
        self.root = root
        self.root.title("FTIR Data Plotter")
        self.file_list = []

        # Create GUI elements
        self.create_widgets()

    def create_widgets(self):
        self.frame = tk.Frame(self.root)
        self.frame.pack(padx=10, pady=10)

        self.add_button = tk.Button(self.frame, text="Add FTIR Data Files", command=self.add_files)
        self.add_button.grid(row=0, column=0, padx=5, pady=5)

        self.plot_button = tk.Button(self.frame, text="Plot Data", command=self.plot_data)
        self.plot_button.grid(row=0, column=1, padx=5, pady=5)

        self.listbox = tk.Listbox(self.frame, selectmode=tk.MULTIPLE, width=50, height=15)
        self.listbox.grid(row=1, column=0, columnspan=2, padx=5, pady=5)

    def add_files(self):
        filenames = filedialog.askopenfilenames(title="Select FTIR Data Files",
                                                filetypes=[("Text Files", "*.txt"), ("All Files", "*.*")])
        if filenames:
            for filename in filenames:
                self.file_list.append(filename)
                self.listbox.insert(tk.END, filename)
    
    def plot_data(self):
        if not self.file_list:
            messagebox.showwarning("No Files Selected", "Please add at least one FTIR data file.")
            return

        # Create a new Tkinter window for the plot
        plot_window = tk.Toplevel(self.root)
        plot_window.title("FTIR Data Plot")

        # Create a figure and plot the data
        fig, ax = plt.subplots(figsize=(10, 6))
        for file in self.file_list:
            try:
                data = pd.read_csv(file, delim_whitespace=True, header=None)
                wavenumber = data.iloc[:, 0]
                intensity = data.iloc[:, 1]
                ax.plot(wavenumber, intensity, label=file.split('/')[-1])
            except Exception as e:
                messagebox.showerror("Error Reading File", f"An error occurred while reading {file}:\n{e}")
                return

        ax.set_xlim(4000, 400)
        ax.set_xlabel("Wavenumber (cm^-1)")
        ax.set_ylabel("Intensity")
        ax.set_title("FTIR Data")
        ax.legend()
        ax.grid(True)

        # Embed the plot into a tkinter canvas
        canvas = FigureCanvasTkAgg(fig, master=plot_window)
        canvas.draw()
        canvas.get_tk_widget().pack(side=tk.TOP, fill=tk.BOTH, expand=True)

        # Add matplotlib navigation toolbar
        toolbar = matplotlib.backends.backend_tkagg.NavigationToolbar2Tk(canvas, plot_window)
        toolbar.update()
        canvas.get_tk_widget().pack(side=tk.TOP, fill=tk.BOTH, expand=True)

        # Function to destroy plot window when closed
        def on_close():
            plot_window.destroy()

        plot_window.protocol("WM_DELETE_WINDOW", on_close)

if __name__ == "__main__":
    root = tk.Tk()
    app = FTIRPlotter(root)
    root.mainloop()
